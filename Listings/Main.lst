C51 COMPILER V9.54   MAIN                                                                  10/05/2015 12:31:28 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\Main.obj
COMPILER INVOKED BY: D:\Keil_MDK\C51\BIN\C51.EXE Main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\Mai
                    -n.lst) OBJECT(.\Objects\Main.obj)

line level    source

   1          //*************************************************************//
   2          //                                      智能温室监控大棚
   3          //                              单片机 AT89S52 或 STC89C52RC 
   4          //                                      Ryan_yuans      2015.10
   5          //*************************************************************//
   6          
   7          #include <reg51.h>
   8          #include <intrins.h> 
   9          //
  10          typedef unsigned char  U8;       /* defined for unsigned 8-bits integer variable          无符号8位整型变量  */
  11          typedef signed   char  S8;       /* defined for signed 8-bits integer variable            有符号8位整型变量  */
  12          typedef unsigned int   U16;      /* defined for unsigned 16-bits integer variable         无符号16位整型变量 */
  13          typedef signed   int   S16;      /* defined for signed 16-bits integer variable           有符号16位整型变量 */
  14          typedef unsigned long  U32;      /* defined for unsigned 32-bits integer variable         无符号32位整型变量 */
  15          typedef signed   long  S32;      /* defined for signed 32-bits integer variable           有符号32位整型变量 */
  16          typedef float          F32;      /* single precision floating point variable (32bits) 单精度浮点数（32位长
             -度） */
  17          typedef double         F64;      /* double precision floating point variable (64bits) 双精度浮点数（64位长
             -度） */
  18          //
  19          #define uchar unsigned char
  20          #define uint unsigned int
  21          #define   Data_0_time    4
  22          
  23          extern void ShowStr(uchar x,uchar y,uchar *str);
  24          extern void Reset1602();
  25          
  26          //----------------------------------------------//
  27          //----------------IO口定义区--------------------//
  28          //----------------------------------------------//
  29          sbit P2_0  = P2^0 ;             // 温湿度数据
  30          sbit DOUT=P2^1;                 // 有害气体浓度数据
  31          
  32          sbit BUZZ = P1^6;
  33          
  34          sbit INA = P1^0;
  35          sbit INB = P1^1;
  36          sbit ENA = P1^2;
  37          
  38          //----------------------------------------------//
  39          //----------------定义区--------------------//
  40          //----------------------------------------------//
  41          U8  U8FLAG;
  42          U8  U8count,U8temp;
  43          U8  U8T_data_H = 0, U8T_data_L = 0, U8RH_data_H = 0, U8RH_data_L = 0, U8checkdata = 0;
  44          U8  U8T_data_H_temp = 0, U8T_data_L_temp = 0, U8RH_data_H_temp = 0, U8RH_data_L_temp = 0, U8checkdata_temp
             - = 0;
  45          U8  U8comdata;
  46          U8  count, count_r=0;
  47          U16 U16temp1,U16temp2;
  48          U8 T0RH = 0;
  49          U8 T0RL = 0;
  50          U8 T1RH = 0;
  51          U8 T1RL = 0;
C51 COMPILER V9.54   MAIN                                                                  10/05/2015 12:31:28 PAGE 2   

  52          U16 flag1s = 0;
  53          uchar str[10];
  54          U8 enbuzz1 = 0,enbuzz2 = 0,enbuzz3 = 0;
  55          U8 ENA_Temp1 = 0,ENA_Temp2 = 0;
  56          
  57          void TrasfToString(U8 *str,U8 dat)
  58          {
  59   1              signed char i = 0;
  60   1              uchar len = 0;
  61   1              uchar buf[6];
  62   1              
  63   1              if(dat < 0)
  64   1              {
  65   2                      dat = -dat;
  66   2                      *str++ = '-';
  67   2                      len++;
  68   2              }
  69   1              
  70   1              do
  71   1              {
  72   2                      buf[i++] = dat % 10;
  73   2                      dat /= 10;
  74   2              }while(dat > 0);
  75   1              
  76   1              len += i;
  77   1              
  78   1              while(i-- > 0)
  79   1              {
  80   2                      *str++ = buf[i] + '0';
  81   2              }
  82   1              
  83   1              *str = '\0';
  84   1      
  85   1      }
  86          
  87          
  88          void Delay(U16 j)
  89          {      U8 i;
  90   1              for(;j>0;j--)
  91   1              {       
  92   2              for(i=0;i<27;i++);
  93   2      
  94   2              }
  95   1      }
  96          
  97          void  Delay_10us(void)
  98          {
  99   1              U8 i;
 100   1              i--;
 101   1              i--;
 102   1              i--;
 103   1              i--;
 104   1              i--;
 105   1              i--;
 106   1      }
 107                  
 108          void  COM(void)
 109           {
 110   1      
 111   1              U8 i;
 112   1                
 113   1              for(i=0;i<8;i++)           
C51 COMPILER V9.54   MAIN                                                                  10/05/2015 12:31:28 PAGE 3   

 114   1              {
 115   2              
 116   2                      U8FLAG=2;       
 117   2              while((!P2_0)&&U8FLAG++)
 118   2                      ;
 119   2              Delay_10us();
 120   2              Delay_10us();
 121   2              Delay_10us();
 122   2              U8temp=0;
 123   2                      
 124   2               if(P2_0)
 125   2                       U8temp=1;
 126   2               
 127   2               U8FLAG=2;
 128   2               
 129   2               while((P2_0)&&U8FLAG++)
 130   2                       ;
 131   2              //超时则跳出for循环               
 132   2               if(U8FLAG==1)
 133   2                       break;
 134   2              //判断数据位是0还是1     
 135   2                 
 136   2              // 如果高电平高过预定0高电平值则数据位为 1 
 137   2               
 138   2                 U8comdata <<= 1;
 139   2                 U8comdata |= U8temp;        // 0 or 1
 140   2               }//rof
 141   1         
 142   1      }
 143          
 144                  /*
 145                  //--------------------------------
 146                  //-----湿度读取子程序 ------------
 147                  //--------------------------------
 148                  //----以下变量均为全局变量--------
 149                  //----温度高8位== U8T_data_H------
 150                  //----温度低8位== U8T_data_L------
 151                  //----湿度高8位== U8RH_data_H-----
 152                  //----湿度低8位== U8RH_data_L-----
 153                  //----校验 8位 == U8checkdata-----
 154                  //----调用相关子程序如下----------
 155                  //---- Delay();, Delay_10us();,COM(); 
 156                  //-------------------------------- ↓
 157                  */
 158          void RH(void)
 159          {
 160   1      
 161   1        //主机拉低18ms 
 162   1         P2_0=0;
 163   1         Delay(180);
 164   1         P2_0=1;
 165   1       //总线由上拉电阻拉高 主机延时20us
 166   1         Delay_10us();
 167   1         Delay_10us();
 168   1         Delay_10us();
 169   1         Delay_10us();
 170   1       //主机设为输入 判断从机响应信号 
 171   1         P2_0=1;
 172   1       //判断从机是否有低电平响应信号 如不响应则跳出，响应则向下运行    
 173   1         if(!P2_0)             //T !    
 174   1         {
 175   2                      TR0 = 0;        //停止定时器计时, 防止中断干扰温湿度数据采集
C51 COMPILER V9.54   MAIN                                                                  10/05/2015 12:31:28 PAGE 4   

 176   2                      TR1 = 0;
 177   2              
 178   2                 U8FLAG=2;
 179   2               //判断从机是否发出 80us 的低电平响应信号是否结束        
 180   2                 while((!P2_0)&&U8FLAG++);
 181   2                 U8FLAG=2;
 182   2               //判断从机是否发出 80us 的高电平，如发出则进入数据接收状态
 183   2                 while((P2_0)&&U8FLAG++);
 184   2               //数据接收状态          
 185   2                 COM();
 186   2                 U8RH_data_H_temp=U8comdata;
 187   2                 COM();
 188   2                 U8RH_data_L_temp=U8comdata;
 189   2                 COM();
 190   2                 U8T_data_H_temp=U8comdata;
 191   2                 COM();
 192   2                 U8T_data_L_temp=U8comdata;
 193   2                 COM();
 194   2                 U8checkdata_temp=U8comdata;
 195   2                 P2_0=1;
 196   2                         
 197   2               //数据校验 ↓
 198   2                              
 199   2                 U8temp = (U8T_data_H_temp + U8T_data_L_temp + U8RH_data_H_temp + U8RH_data_L_temp);
 200   2                 if(U8temp == U8checkdata_temp)
 201   2                 {
 202   3                        U8RH_data_H = U8RH_data_H_temp;
 203   3                        U8RH_data_L = U8RH_data_L_temp;
 204   3                        U8T_data_H = U8T_data_H_temp;
 205   3                        U8T_data_L = U8T_data_L_temp;
 206   3                        U8checkdata = U8checkdata_temp;
 207   3      
 208   3                 }//fi
 209   2         }//fi
 210   1         
 211   1              TR0 = 1;        // 重新打开定时器计时
 212   1              TR1 = 1;
 213   1      }
 214                  
 215          void ConfigTimer0(U16 ms)       // 设置定时器T0 底层驱动
 216          {
 217   1              U32 tmp;
 218   1              
 219   1              tmp = 11059200 / 12;
 220   1              tmp = (tmp * ms) / 1000;
 221   1              tmp = 65536 - tmp;
 222   1              tmp = tmp + 13;
 223   1              T0RH = (uchar)(tmp >> 8);
 224   1              T0RL = (uchar)tmp;
 225   1              TH0 = T0RH;
 226   1              TL0 = T0RL;
 227   1              TMOD &= 0XF0;
 228   1              TMOD |= 0X01;
 229   1              ET0 = 1;
 230   1              TR0 = 1;
 231   1      }
 232          
 233          void ConfigTimer1(U16 ms)       // 设置定时器T1 底层驱动
 234          {
 235   1              U32 tmp;
 236   1              
 237   1              tmp = 11059200 / 12;
C51 COMPILER V9.54   MAIN                                                                  10/05/2015 12:31:28 PAGE 5   

 238   1              tmp = (tmp * ms) / 1000;
 239   1              tmp = 65536 - tmp;
 240   1              tmp = tmp + 2;
 241   1              T1RH = (uchar)(tmp >> 8);
 242   1              T1RL = (uchar)tmp;
 243   1              TH1 = T0RH;
 244   1              TL1 = T0RL;
 245   1              TMOD &= 0X0F;
 246   1              TMOD |= 0X10;
 247   1              ET1 = 1;
 248   1              TR1 = 1;
 249   1      }
 250          
 251          
 252          void ShowTempHumi()                     // 显示温湿度至液晶屏
 253          {
 254   1              
 255   1              TrasfToString(str,U8T_data_H);
 256   1              ShowStr(6,0,str);
 257   1              TrasfToString(str,U8RH_data_H);
 258   1              ShowStr(6,1,str);
 259   1      }
 260          
 261          void Alarm_Monitor()            // 监控各指标_ 温度、湿度、有害气体浓度
 262          {
 263   1              if(DOUT==0)             // 检测有害气体浓度是否超标
 264   1                              {
 265   2                                      Delay(1);       // 延时再次确认
 266   2                                      if(DOUT == 0)   // 当有害气体浓度超标
 267   2                                      {
 268   3                                              enbuzz1 = 1;
 269   3                                              ENA_Temp1 = 1;
 270   3                                      }
 271   2                              }
 272   1                       else
 273   1                              {
 274   2                                      enbuzz1 = 0;
 275   2                                      ENA_Temp1 = 0;
 276   2                              }
 277   1              
 278   1              if(U8T_data_H >= 35)    // 当温度 >= 35°C 时
 279   1                              {
 280   2                                      ShowStr(14,0,"!~");
 281   2                                      ENA_Temp2 = 1;
 282   2                                      enbuzz2 = 1;
 283   2                              }
 284   1                              else
 285   1                              {
 286   2                                      ShowStr(14,0,"  ");
 287   2                                      ENA_Temp2 = 0;
 288   2                                      enbuzz2 = 0;
 289   2                              }
 290   1                              
 291   1                              if(U8RH_data_H >= 60)   // 当湿度 >= 60% 时
 292   1                              {
 293   2                                      ShowStr(14,1,"!~");
 294   2                                      enbuzz3 = 1;
 295   2                              }
 296   1                              else
 297   1                              {
 298   2                                      ShowStr(14,1,"  ");
 299   2                                      enbuzz3 = 0;
C51 COMPILER V9.54   MAIN                                                                  10/05/2015 12:31:28 PAGE 6   

 300   2                              }
 301   1      }
 302          
 303          void Alarm_Action()                     // 指标异常 执行操作
 304          {
 305   1              if((ENA_Temp1 == 1) || (ENA_Temp2 == 1))        // 启动风扇 抽风 降温
 306   1              {
 307   2                      ENA = 1;
 308   2              }
 309   1              else
 310   1              {
 311   2                      ENA = 0;
 312   2              }
 313   1      }
 314                  
 315          //----------------------------------------------
 316          void main()
 317          {
 318   1              
 319   1              INA = 0;
 320   1              INB = 1;
 321   1              ENA = 0;
 322   1              
 323   1              EA = 1;
 324   1              ConfigTimer0(20);               // 20 X 50 = 1 S
 325   1              ConfigTimer1(1);        // ~ BUZZ
 326   1              Reset1602();
 327   1              
 328   1              ShowStr(0,0,"Temp:");
 329   1              ShowStr(0,1,"Humi:");
 330   1              
 331   1              Delay(1);         //延时100US（12M晶振)
 332   1              
 333   1              while(1)
 334   1              {  
 335   2                      
 336   2      /*  调用温湿度读取子程序 读取温湿度！ */
 337   2                      RH();
 338   2                              
 339   2                              
 340   2                      if(flag1s == 1)         
 341   2                      {
 342   3                              flag1s = 0;
 343   3                              
 344   3                              ShowTempHumi();         // 将温湿度显示在液晶屏上
 345   3                              
 346   3                              Alarm_Monitor();        // 监控各指标
 347   3                              
 348   3                              Alarm_Action();         // 风扇机
 349   3                      }               
 350   2                      
 351   2              }//while
 352   1              
 353   1      }// main
 354          
 355          // ---------------------------------------------
 356          void Timer0() interrupt 1
 357          {
 358   1              static U8 timer = 0;
 359   1              
 360   1              TH0 = T0RH;
 361   1              TL0 = T0RL;
C51 COMPILER V9.54   MAIN                                                                  10/05/2015 12:31:28 PAGE 7   

 362   1              
 363   1              
 364   1              timer++;
 365   1              
 366   1              if(timer == 50)         // 计时 20 X 50 ==> 1 S
 367   1              {
 368   2                      timer = 0;
 369   2                      flag1s = 1;
 370   2              }
 371   1      }
 372          
 373          void Timer1() interrupt 3
 374          {
 375   1              TH1 = T1RH;
 376   1              TL1 = T1RL;
 377   1              
 378   1              if((enbuzz1 == 1) || (enbuzz2 == 1) || ((enbuzz3 == 1)))        // 打开蜂鸣器 ~BUZZ
 379   1              {
 380   2                      BUZZ = ~BUZZ;
 381   2              }
 382   1              else
 383   1              {
 384   2                      BUZZ = 1;
 385   2              }
 386   1              
 387   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    904    ----
   CONSTANT SIZE    =     18    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     42      19
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
